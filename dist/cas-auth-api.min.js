!function(e){"use strict";e.module("cas-auth-api",[])}(window.angular),function(e,t){"use strict";e.provider("casAuthApi",function(){function e(e,t,n){var i,a=t.toString();return(angular.isNumber(n)||!isFinite(n)||Math.floor(n)!==n||n>a.length)&&(n=a.length),n-=e.length,i=a.indexOf(e,n),-1!==i&&i===n}function n(e,t,n){return n=n||0,t.indexOf(e,n)===n}function i(e){return void 0!==e&&a.endpoints.hasOwnProperty(e)?a.authenticationApiBaseUrl+"/"+a.endpoints[e]:a.authenticationApiBaseUrl}var a,r,c={endpoints:{service:"service",token:"token/new"},ticketUrl:"",maxAttempts:3,requireAccessToken:!1,cacheAccessToken:!1,cacheExpiresMinutes:25,managedApis:[],casBaseUrl:"https://thekey.me",casLoginPath:"/cas/login",casTicketPath:"/cas/api/oauth/ticket",oAuth:!1,authenticationApiBaseUrl:"https://auth-api.cru.org/v1"},s=["redirectUrl","clientId"];this.configure=function(t){if(a)throw new Error("Already configured.");if(!(t instanceof Object))throw new TypeError("Invalid argument: `config` must be an `Object`.");return a=angular.extend({},c,t),a.oAuth===!0&&angular.forEach(s,function(e){if(!a[e])throw new Error("Missing parameter: "+e+".")}),e("/",a.casBaseUrl)&&(a.casBaseUrl=a.casBaseUrl.slice(0,-1)),e("/",a.authenticationApiBaseUrl)&&(a.authenticationApiBaseUrl=a.authenticationApiBaseUrl.slice(0,-1)),n("/",a.casLoginPath)===!1&&(a.casLoginPath="/"+a.casLoginPath),n("/",a.casLoginPath)===!1&&(a.casTicketPath="/"+a.casTicketPath),a},this.setAuthenticationApiBaseUrl=function(t){return a.authenticationApiBaseUrl=e("/",t)?t.slice(0,-1):t,this},this.setTicketUrl=function(e){return a.ticketUrl=e,this},r=this.addManagedApi=function(e){var t=angular.isString(e)?[e]:e;return angular.forEach(t,function(e){-1===this.indexOf(e)&&this.push(e)},a.managedApis),this},this.setRequireAccessToken=function(e){return a.requireAccessToken=!!e,this},this.setCacheAccessToken=function(e){return a.cacheAccessToken=angular.isUndefined(t)?!1:!!e,this},this.setErrorCallback=function(e){return a.errorCallback=angular.isFunction(e)?e:void 0,this},this.$get=["$injector","$q","$rootScope",function(e,c,s){function o(e){var t;for(t=0;t<a.managedApis.length;t+=1)if(n(a.managedApis[t],e))return!0;return!1}function u(){var t,n,i=e.get("$window").location.hash.substr(1),a=i.split("&"),r={};for(t=0;t<a.length;t+=1)""!==a[t]&&(n=a[t].split("="),r[n[0]]=n[1]);return r}function h(e,t){s.$emit("cas-auth-api:error",{code:e,message:t}),angular.isFunction(a.errorCallback)?a.errorCallback({code:e,message:t}):a.deferredAuthentication.reject(t)}function d(e){a.accessToken=e.data.data.id,a.deferredAuthentication.resolve()}function f(){h("ERR_TOKEN","Failed to fetch token.")}function l(t){var n=a.oAuth===!0?t.data.ticket:t.data.data.id;e.get("$http").get(i("token"),{params:{st:n}}).then(d,f)}function g(){h("ERR_TICKET","Failed to fetch ticket.")}function p(t){var n,i;a.oAuth===!0?(n=a.casBaseUrl+a.casTicketPath,i={params:{service:t.data.data.id},headers:{Authorization:"Bearer "+u().access_token}}):(n=a.ticketUrl,i={params:{service:t.data.data.id}}),e.get("$http").get(n,i).then(l,g)}function k(){h("ERR_SERVICE","Failed to fetch service.")}function A(){angular.isObject(a.deferredAuthentication)||(a.deferredAuthentication=c.defer(),a.accessToken=void 0,a.cacheAccessToken&&angular.isDefined(t)&&t.remove("access_token"),a.oAuth===!0&&void 0===u().access_token&&(e.get("$window").location.href=a.casBaseUrl+a.casLoginPath+"?response_type=token&client_id="+a.clientId+"&redirect_uri="+a.redirectUrl+"&scope=fullticket"),e.get("$http").get(i("service")).then(p,k))}function m(e){var t=c.defer();return A(),a.deferredAuthentication.promise.then(function(){e.headers.Authorization="Bearer "+a.accessToken,t.resolve(e)},function(){t.reject()}),t.promise}function v(e){if(e.url===i("service")||e.url===i("token"))return e;if(o(e.url)){if(angular.isUndefined(a.accessToken)&&a.cacheAccessToken){var n;angular.isDefined(t)&&(n=t.get("access_token")),null!==n&&(a.accessToken=n)}if(e.attempts="number"==typeof e.attempts?e.attempts+1:1,a.requireAccessToken&&angular.isUndefined(a.accessToken)||angular.isObject(a.deferredAuthentication))return m(e);angular.isDefined(a.accessToken)&&(e.headers.Authorization="Bearer "+a.accessToken)}return e}function T(e){return o(e.config.url)&&angular.isDefined(a.accessToken)&&a.cacheAccessToken&&angular.isDefined(t)&&t.set("access_token",a.accessToken,a.cacheExpiresMinutes),e}function U(e){var t=e.headers("WWW-Authenticate");return 401===e.status&&t&&n("CAS",t)}function w(t){if(o(t.config.url)&&U(t)&&t.config.attempts<a.maxAttempts){var n=c.defer();return A(),a.deferredAuthentication.promise.then(function(){e.get("$http")(t.config).then(function(e){n.resolve(e)},function(){n.reject()})},function(){n.reject()}),n.promise}return c.reject(t)}return{request:v,response:T,responseError:w,addManagedApi:r}}]})}(angular.module("cas-auth-api"),window.lscache),function(e,t){"use strict";e.config(["$httpProvider",function(e){e.interceptors.push("casAuthApi")}]),e.run(function(){angular.isDefined(t)&&t.setBucket("cas-auth-api:")})}(angular.module("cas-auth-api"),window.lscache);